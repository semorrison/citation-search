<html>
<head>
	<script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config(
                           {
                           "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] },
                           tex2jax: {
                           inlineMath: [ ["$", "$"], ["\\\\(","\\\\)"] ],
                           displayMath: [ ["$$","$$"], ["\\[", "\\]"] ],
                           processEscapes: true,
                           ignoreClass: "tex2jax_ignore|dno"
                           },
                           TeX: {
                           noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
                           Macros: {
						      bold: ['{\\bf #1}', 1],
						      roman: ['{\\rm #1}', 1],
						      germ: ['{\\mathfrak #1}', 1]
							}
                           },
                           messageStyle: "none"
                           });
        </script>    
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <style>
    	a { text-decoration: none; font-weight:bold; }
    	span.inactive { color:#777777; }
    	dt { font-weight:bold; }
		tr td:first-child {padding-left:0px; }
 		td { padding:10px 0px 10px 50px; }
 		.right { float: right; }
 		#results li:hover { background-color:#CCDCEE; }
	</style>
</head>
<body>
<div>
<b>Search the mathematics literature</b>, by entering any combination of title, authors, and journal reference.
<div class="right">
    <a href="https://github.com/semorrison/citation-search/">(github)</a> <a href="https://github.com/semorrison/citation-search/issues">(issues)</a>
</div>
</div>
<input id="query" size=60 autofocus/><img id="spinner" src="ajax-loader.gif" style="display: none;"/>
<br/>
<table>
	<tr>
		<td valign="top">
			<div id="results">
			</div>
		</td>
		<td valign="top" width=50%>
			<div id="loading-results"></div>
			<div id="article-display"></div>
		</td>
	</tr>
</table>
<script>
var delay = (function(){
  var timer = 0;
  return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
  };
})();

function renderOptionalLink(href, text) {
	if(href) {
		return $('<span><a href="#">' + text + '</a> </span>').click(function() { loadInFrame(href); });
	} else {
		return '<span class="inactive">' + text + '</span> ';
	}
}

function loadInFrame(url) {
	// decide whether to sandbox
	if(url.indexOf('http://journals.aps.org/pra/') == -1) {
		$("#article-display").append('<iframe width=100% height=1000 id="iframe" name="iframe"/>');
		if(url.indexOf('oxfordjournals.org') == -1 && url.indexOf('sciencedirect') == -1) {
			$("#iframe").removeAttr('sandbox');
		} else {
			$("#iframe").attr('sandbox', "allow-same-origin allow-scripts allow-forms");
		}
		$('#loading-results').html('Loading ... <a href="' + url + '">' + url + '</a>');
		$('#iframe').attr('src', url);
	} else {
		// APS journals prohibit framing via 'X-Frame-Options' = 'SAMEORIGIN'
		$('#loading-results').html('No preview available.');
	}
}

function callback(response) {
// response = { 
//	 query: "jones index for subfactors",
//   results: [
//    { citation: {
//	    	MRNumber: 696688, title: "Index for subfactors", authors: "Jones, V. F. R.", cite: "Invent. Math. 72 (1983), no. 1, 1â€“25", url: "http://dx.doi.org/10.1007/BF01389127"
//      },
//      score: 1.0 } 
//   ]
// }
	if($("#query").val() == response.query) {
	   	var html = $('<ol>');
	   	for (var i = 0; i < response.results.length && i < 3; i++) {
       		var result = response.results[i].citation;
	   		var mr = 'http://www.ams.org/mathscinet-getitem?mr=' + result.MRNumber;
	   		var journal = (result.url == mr) ? "" : result.url;
	   		html.append(
	   			$('<li/>')
	   				.append($('<dt/>').append(result.title))
	   				.append($('<dd/>')
	   					.append(result.authors + '<br/>' + result.citation_html  + '<br/>')
	   					.append(renderOptionalLink(mr, 'mathscinet'))
			   			.append(renderOptionalLink(journal, 'journal'))
			   			.append(renderOptionalLink(result.pdf, 'pdf'))
			   			.append(renderOptionalLink(result.free, 'free'))
	   				)
	   				.click((function(currentResult) { return function() { selectResult(currentResult); } })(result))
	   		);
		}
	   	$("#results").empty();
	   	$("#article-display").empty()
	   	$("#results").append(html);
	   	MathJax.Hub.Queue(["Typeset",MathJax.Hub,"results"]);
	   	if(response.results.length > 0) {	   		
	   		loadInFrame(response.results[0].citation.best);
	    }
	   	$("#spinner").hide();
	}	
}

function selectResult(result) {
	var json = JSON.stringify(result);
	if (window == window.top) { 
		loadInFrame(result.best);
	}
	parent.postMessage(json, "*");
}

function getURLParameter(name) {
  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
}

function runQuery(query) {
       	$.getJSON("http://ec2.mathoverflow.org:8080/?callback=?&q=" + query, callback);
      	$("#spinner").show();	
}

var urlQuery;
if(urlQuery = getURLParameter('q')) {
	$("#query").val(urlQuery);
	runQuery(urlQuery);
}

$("#query").keyup(function () {
	delay(function() {
		runQuery($("#query").val());
       }, 500);
});
</script>
</body>
</html>